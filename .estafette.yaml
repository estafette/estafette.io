builder:
  track: dev

labels:
  app: estafette-io
  team: estafette-team
  language: hugo

pipelines:
  git-clone:
    image: extensions/git-clone:dev
    shallow: false

  hugoify:
    image: estafette/hugo:0.42.1
    env:
      GIT_USER_EMAIL: estafette.secret(0ZJRd1ti_4HlsYz6.ie7ynUsbOMTuDEkvBdvDAmB1UL9Hu0YmxTpEve2ARAE_wTonhpe65Ek=)
      GIT_USER_NAME: estafette.secret(nbg9Avv8R7CoZ1O4.GDU-1JwnPpzaBsDcjJhX4CyRhspe4amlBflh3OQoPQ==)
    commands:
    - echo "Deleting old publication"
    - rm -rf public
    - mkdir public
    - git worktree prune
    - rm -rf .git/worktrees/public/
    - echo "Checking out master branch into public"
    - git worktree add -B master public origin/master
    - echo "Removing existing files"
    - rm -rf public/*
    - echo "Generating site"
    - hugo version
    - hugo --enableGitInfo
    - echo "Updating master branch"
    - cp CNAME public/CNAME
    - cp _config.yml public/_config.yml
    - cp .estafette.yaml public/.estafette.yaml
    - git config --global user.email "${GIT_USER_EMAIL}"
    - git config --global user.name "${GIT_USER_NAME}"
    - cd public && git add --all && git commit --allow-empty -m "Publishing version ${ESTAFETTE_BUILD_VERSION}"
    - git push origin master
    when:
      status == 'succeeded' &&
      branch == 'source'

  jekyllify:
    image: jekyll/jekyll:3.8.3
    commands:
    - chown -R jekyll:jekyll .
    - jekyll build --safe
    when:
      status == 'succeeded' &&
      branch == 'master'