<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-464018-9"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-464018-9');</script><meta charset=utf-8><title>Manifest &ndash; Estafette CI/CD</title><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css integrity=sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB crossorigin=anonymous><link rel=stylesheet href=https://estafette.io/sass/estafette.min.bcceb2567d1f84d8e9c8efd153603c28f7ec531c6a287e25842ae26904734f41.css integrity="sha256-vM6yVn0fhNjpyO/RU2A8KPfsUxxqKH4lhCriaQRzT0E="></head><body><div id=header-and-main><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><a class=navbar-brand href=/>Estafette CI</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNavAltMarkup aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavAltMarkup><div class=navbar-nav><a class="nav-item nav-link" href=/getting-started/>Get started</a>
<a class="nav-item nav-link active" href=/usage/>Usage</a>
<a class="nav-item nav-link" href=/design/>Design</a>
<a class="nav-item nav-link" href=/toplevel/>Top-level page</a></div></div></nav><div id=main><div class=container-fluid><div class=row><div class="col mt-4 mb-4 border-right sidebar"><ul><li class=section-item><a href=/getting-started/>Getting started</a><ul><li class=page-item><a href=/getting-started/installation/>Installation</a></li><li class=page-item><a href=/getting-started/configuration/>Configuration</a></li><li class=section-item><a href=/getting-started/subsection/>Subsection</a><ul><li class=page-item><a href=/getting-started/subsection/nested-page/>Nested page</a></li></ul></li></ul></li><li class=section-item><a href=/usage/>Usage</a><ul><li class=page-item><a href=/usage/manifest/>Manifest</a></li><li class=page-item><a href=/usage/extensions/>Extensions</a></li><li class=page-item><a href=/usage/examples/>Examples</a></li></ul></li><li class=section-item><a href=/design/>Design</a></li><li class=page-item><a href=/toplevel/>Top-level page</a></li></ul></div><div class="col pl-5 pt-4" style=overflow:hidden><h1 class=mb-4>Manifest</h1><h3 id=usage-in-your-application>Usage in your application</h3><p>To build your application with Estafette add an <code>.estafette.yaml</code> file to your application repository.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># these labels turn into ESTAFETTE_LABEL_... envvars, automatically injected into all pipeline steps</span><span class=w>
</span><span class=w></span>labels<span class=p>:</span><span class=w>
</span><span class=w>  </span>app<span class=p>:</span><span class=w> </span>estafette-ci-builder<span class=w>
</span><span class=w>  </span>team<span class=p>:</span><span class=w> </span>estafette-team<span class=w>
</span><span class=w>  </span>language<span class=p>:</span><span class=w> </span>golang<span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># semver version generates a 0.0.x version (or 0.0.x-&lt;branch&gt; for other branches than the release branch)</span><span class=w>
</span><span class=w></span><span class=c># made available as ESTAFETTE_BUILD_VERSION envvar, automatically injected into all pipeline steps</span><span class=w>
</span><span class=w></span>version<span class=p>:</span><span class=w>
</span><span class=w>  </span>semver<span class=p>:</span><span class=w>
</span><span class=w>    </span>major<span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span>minor<span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span>patch<span class=p>:</span><span class=w> </span><span class=s1>&#39;{{auto}}&#39;</span><span class=w>
</span><span class=w>    </span>labelTemplate<span class=p>:</span><span class=w> </span><span class=s1>&#39;{{branch}}&#39;</span><span class=w>
</span><span class=w>    </span>releaseBranch<span class=p>:</span><span class=w> </span>master<span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># global environments variables that are automatically injected into all pipeline steps and can be</span><span class=w>
</span><span class=w></span><span class=c># overridden by defining an envvar in a pipeline step with the same name</span><span class=w>
</span><span class=w></span>env<span class=p>:</span><span class=w>
</span><span class=w>  </span>VAR1<span class=p>:</span><span class=w> </span>somevalue<span class=w>
</span><span class=w>  </span>VAR2<span class=p>:</span><span class=w> </span>another<span class=w> </span>value<span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># pipeline stages are executed sequentially;</span><span class=w>
</span><span class=w></span><span class=c># a step uses a public container to mount the working directory into and execute commands in;</span><span class=w>
</span><span class=w></span><span class=c># extensions are containerized applications that execute based on injected environment variables or</span><span class=w>
</span><span class=w></span><span class=c># custom properties injected as ESTAFETTE_EXTENSION_&lt;PROPERTY&gt; envvars</span><span class=w>
</span><span class=w></span><span class=c># executing or skipping a step is controlled by the &#39;when&#39; property</span><span class=w>
</span><span class=w></span>stages<span class=p>:</span><span class=w>
</span><span class=w>  </span>set-pending-build-status<span class=p>:</span><span class=w>
</span><span class=w>    </span>image<span class=p>:</span><span class=w> </span>extensions/github-status<span class=p>:</span>stable<span class=w>
</span><span class=w>    </span>status<span class=p>:</span><span class=w> </span>pending<span class=w>
</span><span class=w>
</span><span class=w>  </span>build<span class=p>:</span><span class=w>
</span><span class=w>    </span>image<span class=p>:</span><span class=w> </span>golang<span class=p>:</span><span class=m>1.9</span>.<span class=m>2</span>-alpine3.<span class=m>6</span><span class=w>
</span><span class=w>    </span>workDir<span class=p>:</span><span class=w> </span>/go/src/github.com/estafette/${ESTAFETTE_LABEL_APP}<span class=w>
</span><span class=w>    </span>commands<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>apk<span class=w> </span>--update<span class=w> </span>add<span class=w> </span>git<span class=w>
</span><span class=w>    </span>-<span class=w> </span>go<span class=w> </span>test<span class=w> </span>`go<span class=w> </span>list<span class=w> </span>./...<span class=w> </span><span class=sd>| grep -v /vendor/`
</span><span class=sd>    - CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -ldflags &#34;-X main.version=${ESTAFETTE_BUILD_VERSION} -X main.revision=${ESTAFETTE_GIT_REVISION} -X main.branch=${ESTAFETTE_GIT_BRANCH} -X main.buildDate=${ESTAFETTE_BUILD_DATETIME}&#34; -o ./publish/${ESTAFETTE_LABEL_APP} .
</span><span class=sd>
</span><span class=sd>  bake-estafette:
</span><span class=sd>    image: docker:17.09.0-ce
</span><span class=sd>    commands:
</span><span class=sd>    - cp Dockerfile ./publish
</span><span class=sd>    - docker build -f ./publish/Dockerfile -t estafette/${ESTAFETTE_LABEL_APP}:${ESTAFETTE_BUILD_VERSION} ./publish
</span><span class=sd>
</span><span class=sd>  push-to-docker-hub:
</span><span class=sd>    image: docker:17.09.0-ce
</span><span class=sd>    env:
</span><span class=sd>      DOCKER_HUB_USERNAME: estafette.secret(T2YbJ4sAMgJMpZ.YS4vLTh8kdNQ5cBrU2AGztThmzJ7aD8w5a5W_-xY1Cw==)
</span><span class=sd>      DOCKER_HUB_PASSWORD: estafette.secret(_kZ8EraN784wEF.GZEpqauwaEb33PmV7_-_fYfszjbKBEhgEfxvdLvZUE9aXq63tB)
</span><span class=sd>    commands:
</span><span class=sd>    - docker login --username=${DOCKER_HUB_USERNAME} --password=&#34;${DOCKER_HUB_PASSWORD}&#34;
</span><span class=sd>    - docker push estafette/${ESTAFETTE_LABEL_APP}:${ESTAFETTE_BUILD_VERSION}
</span><span class=sd>
</span><span class=sd>  set-build-status:
</span><span class=sd>    image: extensions/github-status:stable
</span><span class=sd>
</span><span class=sd>  slack-notify:
</span><span class=sd>    image: extensions/slack-build-status:stable
</span><span class=sd>    webhook: estafette.secret(VQhyeydGURZSFLmh.LVhcvAuxx5EsgBqRJ9kvxXsvpZdSkP9pQ6AzUU5rrsFeKQAAAf8fGtQ6VhXL5qThw5m8hrsBASWQKaaYsGn5ZmC5jTUKpLfgg7YR)
</span><span class=sd>    name: ${ESTAFETTE_LABEL_APP}
</span><span class=sd>    channels:
</span><span class=sd>    - &#39;#build-status&#39;
</span><span class=sd>    when:
</span><span class=sd>      status == &#39;failed&#39;</span></code></pre></div><h2 id=running-a-build>Running a build</h2><p>The <strong>CI builder</strong> is the component that interprets the <code>.estafette.yaml</code> file and executes the pipeline stages specified in there.</p><p>At this time the yaml file consist of two top-level sections, <em>labels</em> and <em>stages</em>.</p><h2 id=labels>Labels</h2><p><em>Labels</em> are not required, but are useful to keep pipelines slightly less application-specific by using the labels as variables. In the future labels will be the mechanism to easily filter application pipelines by label values.</p><p>Any of the labels can be used in all the pipeline steps with the environment variable <code>ESTAFETTE_LABEL_&lt;LABEL NAME&gt;</code> in snake-casing.</p><h2 id=stages>Stages</h2><p>The <em>stages</em> section allows you to define multiple steps to run within public Docker containers. Within each step you specify the public Docker image to use and the commands to execute within the Docker container. Your cloned repository is mounted within the docker container at <code>/estafette-work</code> by default, but you can override it with the <code>workDir</code> setting in case you need your code to live in a certain directory structure like with certain golang projects.</p><p>All files in the working directory are passed from step to step. Any files stored outside the working directory are not passed on. This means that - for example - when fetching NuGet packages with .NET core you specify the packages directory to be stored within the working directory, so it&rsquo;s available in the following steps.</p><p>For each step you can use a different Docker image, but it&rsquo;s best practice to minimize the number of different images / versions in order to save time on downloading all the Docker images.</p><p>Pipeline steps run in sequence. With the <code>when</code> property you can specify a logical expression - in golang format - to determine whether the step should run or be skipped. This is useful to, for example, only push docker containers to a registry for certain branches. Or to fire a notification if any of the previous steps has failed. The default <code>when</code> condition is <code>status == 'succeeded'</code>.</p><h2 id=releasing-from-estafette-ci>Releasing from Estafette CI</h2><p>In order to release your applications, whether it&rsquo;s a Maven package to push to a repository, a Docker container to push to a registry or a deployment to Kubernetes, you can do this with Estafette CI by defining release targets in the <code>.estafette.yaml</code> file:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>...<span class=w>
</span><span class=w>
</span><span class=w></span>releases<span class=p>:</span><span class=w>
</span><span class=w>  </span>latest<span class=p>:</span><span class=w>
</span><span class=w>    </span>stages<span class=p>:</span><span class=w>
</span><span class=w>      </span>tag-container-image-as-latest<span class=p>:</span><span class=w>
</span><span class=w>        </span>image<span class=p>:</span><span class=w> </span>docker<span class=p>:</span><span class=m>18.03</span>.<span class=m>1</span>-ce<span class=w>
</span><span class=w>        </span>env<span class=p>:</span><span class=w>
</span><span class=w>          </span>DOCKER_HUB_USERNAME<span class=p>:</span><span class=w> </span>estafette.secret(<span class=cp>***)</span><span class=w>
</span><span class=w>          </span>DOCKER_HUB_PASSWORD<span class=p>:</span><span class=w> </span>estafette.secret(<span class=cp>***)</span><span class=w>
</span><span class=w>        </span>commands<span class=p>:</span><span class=w>
</span><span class=w>        </span>-<span class=w> </span>docker<span class=w> </span>login<span class=w> </span>--username=${DOCKER_HUB_USERNAME}<span class=w> </span>--password=<span class=s2>&#34;${DOCKER_HUB_PASSWORD}&#34;</span><span class=w>
</span><span class=w>        </span>-<span class=w> </span>docker<span class=w> </span>pull<span class=w> </span>estafette/estafette-ci-api<span class=p>:</span>${ESTAFETTE_BUILD_VERSION}<span class=w>
</span><span class=w>        </span>-<span class=w> </span>docker<span class=w> </span>tag<span class=w> </span>estafette/estafette-ci-api<span class=p>:</span>${ESTAFETTE_BUILD_VERSION}<span class=w> </span>estafette/estafette-ci-api<span class=p>:</span>latest<span class=w>
</span><span class=w>        </span>-<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>estafette/estafette-ci-api<span class=p>:</span>${ESTAFETTE_BUILD_VERSION}</code></pre></div><p>Currently these release targets can be triggered via the Slack integration; web gui and cli support will follow later. To trigger a release from Slack you use the following Slash command:</p><pre><code>/estafette release &lt;repo name&gt; &lt;release target&gt; &lt;version&gt;
</code></pre><p>An example with the release sample as above would be:</p><pre><code>/estafette release estafette-ci-api latest 0.0.21
</code></pre><p>If the repository name is not unique within your Estafette CI database you&rsquo;ll have to specificy the full repo path like:</p><pre><code>/estafette release github.com/estafette/estafette-ci-api latest 0.0.21
</code></pre><h3 id=use-files-from-the-git-repository>Use files from the git repository</h3><p>By default - to speed things up - the release targets do not clone the git repository. If you need to have access to the files in your git repository you can do so by using the <code>git-clone</code> extension as the first stage:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>...<span class=w>
</span><span class=w>
</span><span class=w></span>releases<span class=p>:</span><span class=w>
</span><span class=w>  </span>latest<span class=p>:</span><span class=w>
</span><span class=w>    </span>stages<span class=p>:</span><span class=w>
</span><span class=w>      </span>git-clone<span class=p>:</span><span class=w>
</span><span class=w>        </span>image<span class=p>:</span><span class=w> </span>extensions/git-clone<span class=p>:</span>dev<span class=w>
</span><span class=w>
</span><span class=w>      </span>tag-container-image-as-latest<span class=p>:</span><span class=w>
</span><span class=w>        </span>...</code></pre></div><p>This brings in the last 50 revisions of the particular branch the version was built from.</p><p>If you need to be able to release older versions you can do a full clone by specifying property <code>shallow: false</code> on the git-clone stage:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>...<span class=w>
</span><span class=w>
</span><span class=w></span>releases<span class=p>:</span><span class=w>
</span><span class=w>  </span>latest<span class=p>:</span><span class=w>
</span><span class=w>    </span>stages<span class=p>:</span><span class=w>
</span><span class=w>      </span>git-clone<span class=p>:</span><span class=w>
</span><span class=w>        </span>image<span class=p>:</span><span class=w> </span>extensions/git-clone<span class=p>:</span>dev<span class=w>
</span><span class=w>        </span>shallow<span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>tag-container-image-as-latest<span class=p>:</span><span class=w>
</span><span class=w>        </span>...</code></pre></div><h3 id=rolling-back-a-release>Rolling back a release</h3><p>Currently there&rsquo;s no dedicated way to roll back a release except for just releasing the previous version again.</p></div></div></div></div></div><nav class="footer nav justify-content-end bg-dark p-2"><a href=https://github.com/estafette/estafette-ci-central target=_blank class="nav-link text-light">Github</a></nav></body></html>