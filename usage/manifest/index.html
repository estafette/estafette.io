<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-464018-9"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-464018-9');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=xQdjvJ8Lmw"><link rel=manifest href="/site.webmanifest?v=xQdjvJ8Lmw"><link rel=mask-icon href="/safari-pinned-tab.svg?v=xQdjvJ8Lmw" color=#28a745><link rel="shortcut icon" href="/favicon.ico?v=xQdjvJ8Lmw"><meta name=msapplication-TileColor content=#ffffff><meta name=theme-color content=#ffffff><title>Manifest &ndash; Estafette CI/CD</title><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://estafette.io/sass/estafette.min.daa8667c18dee5e14fbeec902662f83d41f9ce67e357f6a246d8e42655fab315.css integrity="sha256-2qhmfBje5eFPvuyQJmL4PUH5zmfjV/aiRtjkJlX6sxU="></head><body><div id=header-and-main><nav class="navbar navbar-dark bg-dark navbar-expand-md"><a href=/ class="navbar-brand text-white mr-3 router-link-exact-active active" target=_self><svg style="width:1.25em;overflow:visible;vertical-align:-2.5px" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="shipping-fast" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="m-0 ml-2 mr-2 h5 svg-inline--fa fa-shipping-fast fa-w-20"><path fill="currentcolor" d="M624 352h-16V243.9c0-12.7-5.1-24.9-14.1-33.9L494 110.1c-9-9-21.2-14.1-33.9-14.1H416V48c0-26.5-21.5-48-48-48H112C85.5.0 64 21.5 64 48v48H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h272c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H40c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H64v128c0 53 43 96 96 96s96-43 96-96h128c0 53 43 96 96 96s96-43 96-96h48c8.8.0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zM160 464c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm320 0c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm80-208H416V144h44.1l99.9 99.9V256z"/></svg><em class=align-top>Estafette</em></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNavAltMarkup aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavAltMarkup><div class=navbar-nav><a class="nav-item nav-link" href=/getting-started/>Getting started</a><a class="nav-item nav-link active" href=/usage/>Usage</a><a class="nav-item nav-link" href=/design/>Design</a><a class="nav-item nav-link" href=/screenshots/>Screenshots</a></div></div></nav><div id=main><div class=container-fluid><div class="row mt-4 mb-4"><div class="col d-none d-md-flex border-right sidebar sticky-top"><ul><li class=section-item><a href=/getting-started/ class=section-item-link>Getting started</a></li><li class=section-item><a href=/usage/ class="section-item-link ancestor">Usage</a><ul><li class=page-item><a href=/usage/manifest/ class="page-item-link active">Manifest</a></li><li class=section-item><a href=/usage/extensions/ class=section-item-link>Extensions</a></li><li class=page-item><a href=/usage/best-practices/ class=page-item-link>Best practices</a></li><li class=page-item><a href=/usage/examples/ class=page-item-link>Examples</a></li></ul></li><li class=section-item><a href=/design/ class=section-item-link>Design</a></li><li class=section-item><a href=/screenshots/ class=section-item-link>Screenshots</a></li></ul></div><div class="col pl-5 pr-5 pt-4 content-block"><h1 class=mb-4>Manifest</h1><p>Estafette is manifest-controlled. That means each build and stage is controlled via the manifest. No more fiddling in a GUI to set up a pipeline.</p><h2 id=labels>Labels</h2><p>Your manifest usually starts with a set of labels; these labels are useful to quickly filter pipelines in the GUI or api, but it also helps for reusing the same application name in your build or release steps.</p><p>In the manifest labels can be specified within the <code>labels</code> section; you have full freedom to come up with additional keys for your labels:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>labels:
  app: estafette-ci-builder
  team: estafette-team
  language: golang</code></pre></div><p>The labels are available as <code>ESTAFETTE_LABEL_&lt;UPPER_SNAKE_CASE_OF_LABEL_VALUE&gt;</code> in your build and release stages.</p><h2 id=build-stages>Build stages</h2><p>On every <code>git push</code> to repositories in associated hosted git services Estafette receives a signal that there&rsquo;s new commits and starts the build stages as defined in the <code>stages</code> section.</p><p>For each stage you can define a public container image to be used or when you&rsquo;ve configured private repositories in the Estafette server you can use images from those as well.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>stages:
  restore:
    image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
    commands:
    - npm ci

  unit-test:
    image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
    commands:
    - npm run unit

  build:
    image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
    commands:
    - npm run build

  bake:
    image: extensions/docker:stable
    action: build
    repositories:
    - estafette
    path: ./publish
    copy:
    - dist
    - favicon.ico
    - nginx.vh.default.conf

  push-to-docker-hub:
    image: extensions/docker:stable
    action: push
    repositories:
    - estafette</code></pre></div><p>Notes:</p><ul><li>Estafette automatically injects a stage to clone the git repository.</li><li>It&rsquo;s best practice to pin the versions of each image, instead of using <code>latest</code> to ensure your build still runs when you haven&rsquo;t touched in a long time.</li></ul><h3 id=parallel-stages>Parallel stages</h3><p>To reduce the total run time of your pipeline you can run stages in parallel. This can be done by nesting stages inside an outer stage within the <code>parallelStages</code> parameter.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>stages:
  prepare:
    parallelStages:
      audit:
        image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
        commands:
        - npm audit

      restore:
        image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
        commands:
        - npm ci

  build-and-test:
    parallelStages:
      unit-test:
        image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
        commands:
        - npm run unit

      build:
        image: node:<span style=color:#3af>10.9</span>.<span style=color:#3af>0</span>-alpine
        commands:
        - npm run build</code></pre></div><p>Notes:</p><ul><li>Only run stages in parallel that don&rsquo;t depend on the outcome of each other.</li><li>You can set the <code>when</code> clause either on the nested stages or on the outer stage.</li><li>When using <code>parallelStages</code> the parameters <code>image</code> and <code>commands</code> are disallowed on the outer stage. It essentially just becomes a wrapper of the stages running in parallel.</li></ul><h3 id=service-containers>Service containers</h3><p>To run advanced integration tests service containers can run services in the background. You can think of running a database for testing your database migration scripts or queries in your code. Or to run your just baked application container as a service and run integration tests against it.</p><p>To reduce the total run time of your pipeline you can run stages in parallel. This can be done by nesting stages inside an outer stage within the <code>parallelStages</code> parameter.</p><p><em>An example with a database as service container:</em></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>stages:
  integration-tests:
    services:
    <span style=color:#888;font-style:italic># run cockroachdb database to test migration scripts against</span>
    - name: cockroachdb
      image: cockroachdb/cockroach:v19.<span style=color:#3af>2.0</span>
      shell: /bin/bash
      env:
        COCKROACH_SKIP_ENABLING_DIAGNOSTIC_REPORTING: <span style=color:#5a2>&#34;true&#34;</span>
      readiness:
        path: /health?ready=<span style=color:#3af>1</span>
        port: <span style=color:#3af>8080</span>
        timeoutSeconds: <span style=color:#3af>120</span>
      commands:
      - /cockroach/cockroach start-single-node --insecure --advertise-addr cockroachdb
    <span style=color:#888;font-style:italic># the main stage executing the just baked migration scripts container</span>
    image: estafette/estafette-ci-db-migrator:${ESTAFETTE_BUILD_VERSION}
    env:
      COCKROACH_CONNECTION_STRING: postgresql://root@cockroachdb:<span style=color:#3af>26257</span>/defaultdb?sslmode=disable
      ESTAFETTE_LOG_FORMAT: console</code></pre></div><p><em>An example with your freshly baked application image as a service:</em></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>stages:
  integration-tests:
    services:
    <span style=color:#888;font-style:italic># run cockroachdb database to test migration scripts against</span>
    - name: ci.estafette.io
      image: estafette/estafette-ci-web:${ESTAFETTE_BUILD_VERSION}
      readiness:
        path: /readiness
        port: <span style=color:#3af>5000</span>
    <span style=color:#888;font-style:italic># the main stage executing your e2e tests</span>
    image: node:<span style=color:#3af>12.2</span>.<span style=color:#3af>0</span>-alpine
    env:
      E2E_HOSTNAME: ci.estafette.io
    commands:
    - npm run e2e</code></pre></div><p>Notes:</p><ul><li>The name of the service can be reached from the main stage (or parallel stages) by it&rsquo;s name</li><li>The service name can be set to a full hostname, like <code>ci.estafette.io</code> hiding the actual site and allowing you to run your tests like you run them against your production environment</li><li>You can set the <code>when</code> clause either on the service containers or on the outer stage.</li><li>Service containers can be used in combination with <code>parallelStages</code></li><li>To wait for the service container to be ready before starting the main stage specify the <code>readiness</code> property with at least the <code>path</code> and <code>port</code>. The default timeout is 60 seconds.</li></ul><h2 id=releases>Releases</h2><p>In Estafette release are triggered by a manual action via either the GUI or via Slack integration. Releases aren&rsquo;t just for deploying code, but can be used for any release action like pushing a Maven or Nuget package, tagging a docker container and more.</p><p>Within the <code>releases</code> section you can define one or multiple <em>release targets</em> - for example development, staging and production - within which you can define stages in a similar fashion as in the build <code>stages</code> section.</p><h6 id=a-release-to-trigger-a-deployment>A release to trigger a deployment</h6><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>releases:
  tooling:
    stages:
      deploy:
        image: extensions/gke:stable
        namespace: estafette
        visibility: public
        container:
          repository: estafette
        hosts:
        - ci.estafette.io</code></pre></div><h6 id=a-release-to-promote-a-docker-container-to-beta-or-stable>A release to promote a docker container to &lsquo;beta&rsquo; or &lsquo;stable&rsquo;</h6><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>releases:
  beta:
    stages:
      tag-container-image:
        image: extensions/docker:stable
        action: tag
        container: gke
        repositories:
        - extensions
        tags:
        - beta

  stable:
    stages:
      tag-container-image:
        image: extensions/docker:stable
        action: tag
        container: gke
        repositories:
        - extensions
        tags:
        - stable
        - latest</code></pre></div><h6 id=release-actions>Release actions</h6><p>For a slightly more advanced workflow you can define <em>actions</em> on a release target, which can be separately triggered from the GUI for that particular <em>release target</em>. The triggered action is passed down to the release stage containers as environment variable <code>ESTAFETTE_RELEASE_ACTION</code>. The Estafette server itself is unaware of the meaning of the action at this moment, but the <code>extensions/gke</code> image is one of the extension that makes use of the following actions and exhibits different behaviour dependening on what action is triggered.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>releases:
  production:
    actions:
    - name: deploy-canary
    - name: deploy-stable
    - name: rollback-canary
    stages:
      deploy:
        image: extensions/gke:stable</code></pre></div><p>Notes:</p><ul><li>There&rsquo;s currently no order in actions or dependencies between them so it&rsquo;s up to the user to trigger them in the correct order</li><li>Unlike the build stages git clone doesn&rsquo;t happen by default in order to speed releases that don&rsquo;t require it up</li></ul><p>To have the git-clone stage get automatically injected set the <code>clone: true</code> property on the stage target:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>releases:
  tooling:
    clone: <span style=color:#00f>true</span>
    stages:
      deploy:
        image: extensions/gke:stable
        namespace: estafette
        visibility: public
        container:
          repository: estafette
        hosts:
        - ci.estafette.io</code></pre></div><h2 id=a-stage-in-detail>A stage in detail</h2><p>The individual stages of a build or release share nothing except for the cloned repository mounted into each stage container. Passing on information can be done via this working directory.</p><h6 id=image>Image</h6><p>With the <code>image</code> tag you can define which Docker container is used to execute this stage. You can use any public container or if you define private registries in the Estafette server those are available to use as well.</p><p>Notes:</p><ul><li>One of the goals of Estafette is to decouple individual application builds as much as possible by sharing nothing; no build agents with shared dependencies. So be cautious when creating builder images that are shared between many applications, because you might lose the advantage of being able to upgrade one application at a time to the latest and greatest version of your language of choice.</li></ul><h6 id=shell>Shell</h6><p>By default the shell used to execute <code>commands</code> is <code>/bin/sh</code>. With the <code>shell</code> tag you can override this to for example <code>/bin/bash</code>.</p><h6 id=working-directory>Working directory</h6><p>The cloned git repository is mounted into the <code>/estafette-work</code> directory by default. In some cases you want to be able to override this. For example complex golang applications with nested packages need to be build within a certain directory structure.</p><p>You can set an override like this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>workDir: /go/src/github.com/estafette/estafette-ci-api</code></pre></div><p>Or by using predefined estafette environment variables:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>workDir: /go/src/${ESTAFETTE_GIT_SOURCE}/${ESTAFETTE_GIT_OWNER}/${ESTAFETTE_GIT_NAME}</code></pre></div><h6 id=commands>Commands</h6><p>Unless you make use of extensions it&rsquo;s likely that you&rsquo;ll pass <code>commands</code> to the stage image to execute certain behaviour. You can define one or more commands which are executed sequentially:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>restore:
  image: microsoft/dotnet:<span style=color:#3af>2.1</span>-sdk
  commands:
  - dotnet restore --packages .nuget/packages

build:
  image: microsoft/dotnet:<span style=color:#3af>2.1</span>-sdk
  commands:
  - dotnet build --version-suffix ${ESTAFETTE_BUILD_VERSION_PATCH}</code></pre></div><p>You could also chose to combine these stages into a single stage like this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>restore:
  image: microsoft/dotnet:<span style=color:#3af>2.1</span>-sdk
  commands:
  - dotnet restore
  - dotnet build --version-suffix ${ESTAFETTE_BUILD_VERSION_PATCH}</code></pre></div><p>A compelling reason to split things up into multiple stages is to get individual timings on the various stages which you can use to find the best opportunity to improve performance in your build pipeline.</p><h6 id=environment-variables>Environment variables</h6><p>To pass environment variables into a build/release stage you can use the <code>env</code> tag to specify one or more environment variables in the image.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>build:
  image: golang:<span style=color:#3af>1.11</span>.<span style=color:#3af>1</span>-alpine3.<span style=color:#3af>8</span>
  workDir: /go/src/github.com/estafette/${ESTAFETTE_GIT_NAME}
  env:
    CGO_ENABLED: <span style=color:#3af>0</span>
    GOOS: linux
  commands:
  - go test `go list ./... | grep -v /vendor/`</code></pre></div><p>Note:
* The globally set Estafette environment variables are automatically injected into each stage container, so you don&rsquo;t have to do that explicitly.</p><h6 id=when-clause>When clause</h6><p>To control execution of each individual step you can use complex conditions - in golang notation - to control whether the stage gets executed or not.</p><p>By default a stage only executes if all stages before it have been executed succesfully. The implicit value of the <code>when</code> tag looks like this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>when:
  status == <span style=color:#5a2>&#39;succeeded&#39;</span></code></pre></div><p>To ensure that for example you only push Docker containers for a specific branch you can use the following condition:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>when:
  status == <span style=color:#5a2>&#39;succeeded&#39;</span> <span style=color:#888;font-style:italic>&amp;&amp;</span>
  branch == <span style=color:#5a2>&#39;master&#39;</span></code></pre></div><p>Do note that you have to repeat the <code>status == 'succeeded'</code>; we don&rsquo;t prepend this by default to your when clause so you can actually trigger stages on failure as well; very useful for notifications in case of failure.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>when:
  status == <span style=color:#5a2>&#39;failed&#39;</span></code></pre></div><h6 id=retries>Retries</h6><p>If you have flaky stages you obviously want to improve what happens in that stage to be more reliable; but a quick stop-gap to at least retry the full stage in case of failure can be to set a number of retries before it&rsquo;s seen as a real failure with the <code>retries</code> tag.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>retries: <span style=color:#3af>3</span></code></pre></div><h6 id=custom-properties>Custom properties</h6><p>When you set unrecognized keywords - none of the above - in a stage Estafette automatically sees those as custom properties which are injected into the stages as environment variables; this is useful to create extensions with a friendlier set of parameters to control the behaviour.</p><p>In case a parameter is of type string, boolean, integer of an array of strings they are injected into the container as an environment variable with name <code>ESTAFETTE_EXTENSION_&lt;UPPER_SNAKE_CASE_OF_THE_TAG_NAME&gt;</code>.</p><p>All of the custom properties together are also json serialized and injected with environment variable name <code>ESTAFETTE_EXTENSION_CUSTOM_PROPERTIES</code>. This way you can use more complex and nested structures to deserialize within your extension.</p><h2 id=environment-variables-1>Environment variables</h2><p>Besides the environment variables defined at each individual stage you can also set global environment variables with top-level section <code>env</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>env:
  VAR_A: Greetings
  VAR_B: World</code></pre></div><p>These are also automatically injected into each individual stage container; if the same environment variable name is used at the stage level it overrides the global one.</p><h2 id=secret-values>Secret values</h2><p>In order to be able to use secret values in your various steps the Estafette server is configured with an AES key of 32 bytes in order to use AES-256 to encrypt secrets.</p><p>Currently values can be encrypted via the Slack integration with Slash command <code>/estafette encrypt &lt;your secret value&gt;</code>.</p><p>This returns a string of the form <code>estafette.secret(***)</code> which can be used as value for your environment variables or custom properties.</p><h2 id=triggers>Triggers</h2><p>To connect pipelines to each other or trigger on other events you have both <em>build</em> and <em>release</em> triggers.</p><p>A trigger consists of a filter specific to the type of trigger; currently <code>pipeline</code> and <code>release</code> are supported, possible future additions are <code>cron</code>, <code>docker</code>, <code>git</code> (for non-estafette repositories). The second part of a trigger indicates the action. In a <em>build</em> trigger this is defined by the <code>builds</code> property, in a <em>release</em> trigger this is defined by the <code>releases</code> property.</p><h3 id=on-pipeline-event>On pipeline event</h3><p>Build triggers are defined in a global <code>triggers</code> section. For example the following trigger would start a build using the latest revision from the master branch after pipeline <code>github.com/estafette/estafette-ci-manifest</code> has successfully completed a master branch build:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>triggers:
- pipeline:
    name: github.com/estafette/estafette-ci-manifest
    branch: master
  builds:
    branch: master</code></pre></div><p>Release triggers are are set on a release target and can specify which action to trigger, or the <code>releases</code> section on the trigger can be dropped if no actions are set.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>releases:
  development:
    actions:
    - deploy-canary
    - ...

    triggers:
    - pipeline:
        name: self
        branch: master
      releases:
        action: deploy-canary

    stages:
      ...</code></pre></div><p>Notes:</p><ul><li>Instead of using the full pipeline name you can use <code>self</code> if you want to trigger on events from the same pipeline. This applies to the release events below as well.</li></ul><h3 id=on-release-event>On release event</h3><p>If you want to trigger on another release finishing use:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>triggers:
- release:
    name: github.com/estafette/estafette-ci-api
    target: development
  builds:
    branch: master</code></pre></div><h3 id=on-cron-schedule>On cron schedule</h3><p>If you want to trigger a <em>build</em> or <em>release</em> on a schedule you can do so with</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>triggers:
- cron:
    schedule: <span style=color:#5a2>&#39;*/15 * * * *&#39;</span></code></pre></div><p>The cron schedule is of the format <code>&lt;minute&gt; &lt;hour&gt; &lt;day of the month&gt; &lt;month&gt; &lt;day of the week&gt;</code>.</p><p>If you want a cron trigger on a release to re-release the same version as is already released use the following:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>releases:
  development:
    triggers:
    - cron:
        schedule: <span style=color:#5a2>&#39;*/15 * * * *&#39;</span>
      releases:
        version: current
    stages:
      ...</code></pre></div><p>Supported values for the <code>version</code> parameter are <code>latest</code> (default), <code>current</code> or an explicit version number.</p><p>Notes:</p><ul><li>The <code>branch</code> and <code>target</code> properties in the <em>filters</em> accept golang regular expressions. This for one means negative lookahead isn&rsquo;t supported. To negate a value, you can prefix your regular expression by one of the PromQL operators for regular expression comparison: <code>=~</code> or <code>!~</code>. The first one is the same as default, but with the second one you can negate the value, for example by setting <code>branch: '!~ master'</code> you can trigger on any non-master branch build finishing.</li></ul><h3 id=on-pub-sub-event>On pub/sub event</h3><p>If you want to trigger a <em>build</em> or <em>release</em> on a pub/sub event coming into a topic use the following definition:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>triggers:
- pubsub:
    project: my-project-id
    topic: topic-name</code></pre></div><p>It doesn&rsquo;t inspect the contents of the message at this time, so it can listen to any pub/sub event.</p><p>In order for the Estafette CI api to create a subscription to the topic and validate incoming events the following config sections needs to be added in the Estafette CI api <code>config.yaml</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>integrations:
  ...
  pubsub:
    defaultProject: my-project-id
    endpoint: https://myestafette-ci.host.com/api/integrations/pubsub/events
    audience: somerandomaudiencekey
    serviceAccountEmail: estafette-ci-api@my-project-id.iam.gserviceaccount.com
    subscriptionNameSuffix: ~estafette-ci-pubsub-trigger
    subscriptionIdleExpirationDays: <span style=color:#3af>365</span></code></pre></div><p>And on all projects that have topics to subscribe to it estafette-ci-api&rsquo;s service account needs the following roles:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- pubsub.subscriber
- pubsub.editor</code></pre></div><h2 id=versioning>Versioning</h2><p>By default Estafette uses semantic versioning with the following values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>version:
  semver:
    major: <span style=color:#3af>0</span>
    minor: <span style=color:#3af>0</span>
    patch: <span style=color:#5a2>&#39;{{auto}}&#39;</span>
    labelTemplate: <span style=color:#5a2>&#39;{{branch}}&#39;</span>
    releaseBranch: master</code></pre></div><p>The <code>patch</code> value is generated from a constantly increasing integer per repository, which increments across all branches, not per branch. This ensures it&rsquo;s unique. When the actual branch is different from the one specified in the <code>releaseBranch</code> tag the <code>labelTemplate</code> is appended to the build counter resulting in a version number like <code>0.0.531-my-pr-branch</code>. For the release branch this will result in a version number like <code>0.0.532</code>.</p><p>If you for example deploy to production from <em>stable master</em> you can use a very minimal spec where the patch is an autoincrementing number and the label is dropped for the <em>master</em> branch with the following snippet:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>version:
  semver:
    major: <span style=color:#3af>1</span>
    minor: <span style=color:#3af>0</span></code></pre></div><p>If you have a public product with releases and want to set a fixed patch you can move the auto-incrementing build number in to the label and only skip the label for the actual release version branch with the following snippet:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>version:
  semver:
    major: <span style=color:#3af>1</span>
    minor: <span style=color:#3af>0</span>
    patch: <span style=color:#3af>0</span>
    labelTemplate: <span style=color:#5a2>&#39;{{branch}}-{{auto}}&#39;</span>
    releaseBranch: <span style=color:#3af>1.0</span>.<span style=color:#3af>0</span></code></pre></div><h2 id=builder-parameters>Builder parameters</h2><p>In order to dogfood Estafette&rsquo;s own components before they&rsquo;re promoted to stable version there&rsquo;s the possibility to set the track to <code>dev</code>, <code>beta</code> or the default value of <code>stable</code>. This controls which version of the builder container is used to execute build steps.</p><pre><code>builder:
  track: stable
</code></pre><p>Notes:</p><ul><li>It&rsquo;s advised to always stay on the stable track to avoid flaky behaviour because a bad version made it into <code>dev</code>.</li></ul><h2 id=global-estafette-environment-variables>Global Estafette environment variables</h2><p>The following Estafette specific global variables are injected automatically into all stage containers to be used at your own disposal:</p><table><thead><tr><th>Environment variable</th><th>Description</th></tr></thead><tbody><tr><td><code>ESTAFETTE_GIT_SOURCE</code></td><td>Indicates the hosted source code system; github.com or bitbucket.org</td></tr><tr><td><code>ESTAFETTE_GIT_OWNER</code></td><td>The owner of the repository; in github.com/estafette/estafette-ci-api the middle value <code>estafette</code> is the owner</td></tr><tr><td><code>ESTAFETTE_GIT_NAME</code></td><td>The name of the repository; in github.com/estafette/estafette-ci-api the last value <code>estafette-ci-api</code> is the name</td></tr><tr><td><code>ESTAFETTE_GIT_FULLNAME</code></td><td>The full name is the owner plus repository name, for example <code>estafette/estafette-ci-api</code></td></tr><tr><td><code>ESTAFETTE_GIT_REVISION</code></td><td>The git sha-1 hash for a commit; it&rsquo;s the hash for the latest commit within a push</td></tr><tr><td><code>ESTAFETTE_GIT_BRANCH</code></td><td>The git branch being built or released</td></tr><tr><td><code>ESTAFETTE_BUILD_DATETIME</code></td><td>This is the UTC time in RFC3339 format that the build started</td></tr><tr><td><code>ESTAFETTE_BUILD_VERSION</code></td><td>The full version number generated by Estafette and the <code>version</code> section in the manifest</td></tr><tr><td><code>ESTAFETTE_BUILD_VERSION_MAJOR</code></td><td>If semantic versioning is used this holds the major version</td></tr><tr><td><code>ESTAFETTE_BUILD_VERSION_MINOR</code></td><td>If semantic versioning is used this holds the minor version</td></tr><tr><td><code>ESTAFETTE_BUILD_VERSION_PATCH</code></td><td>If semantic versioning is used this has the patch version</td></tr><tr><td><code>ESTAFETTE_BUILD_STATUS</code></td><td>Starts out as <code>succeeded</code> but changes to <code>failed</code> as soon as a build/release stage fails</td></tr><tr><td><code>ESTAFETTE_LABEL_...</code></td><td>All items in the <code>labels</code> section are turned into an environment variable of this form; the label key is turned into upper snake case</td></tr><tr><td><code>ESTAFETTE_EXTENSION_...</code></td><td>All custom properties of type string, boolean, integer or array of strings are turned into an environment variable of this form; the tag is turned into upper snake case</td></tr><tr><td><code>ESTAFETTE_EXTENSION_CUSTOM_PROPERTIES</code></td><td>All custom properties of a stage are json serialized and injected into the stage container with this environment variable</td></tr></tbody></table><p>Notes:</p><ul><li>For each of the above environment variables there&rsquo;s also a <code>_DNS_SAFE</code> suffixed version that&rsquo;s safe to use as a DNS label (part between 2 dots), i.e. <code>ESTAFETTE_GIT_BRANCH_DNS_SAFE</code>.</li><li>Don&rsquo;t set any variables starting with <code>ESTAFETTE_</code> yourself, they will be wiped or skipped.</li></ul><h2 id=other>Other</h2><p>To find out more about the Estafette extensions and how they can be used at the <a href=/usage/extensions/>extensions</a> documentation.</p></div><div class="col d-none d-xl-flex border-left toc sticky-top"><ul><li class=section-item><a class="section-item-link ancestor">Table of contents</a><ul><li class=page-item><a href=/usage/manifest/#labels title=Labels class=page-item-link>Labels</a><li class=page-item><a href=/usage/manifest/#build-stages title="Build stages" class=page-item-link>Build stages</a><ul><li class=page-item><a href=/usage/manifest/#parallel-stages title="Parallel stages" class=page-item-link>Parallel stages</a><li class=page-item><a href=/usage/manifest/#service-containers title="Service containers" class=page-item-link>Service containers</a></ul><li class=page-item><a href=/usage/manifest/#releases title=Releases class=page-item-link>Releases</a><ul><li class=page-item><a href=/usage/manifest/#a-release-to-trigger-a-deployment title="A release to trigger a deployment" class=page-item-link>A release to trigger a deployment</a><li class=page-item><a href=/usage/manifest/#a-release-to-promote-a-docker-container-to-beta-or-stable title="A release to promote a docker container to ‘beta’ or ‘stable’" class=page-item-link>A release to promote a docker container to ‘beta’ or ‘stable’</a><li class=page-item><a href=/usage/manifest/#release-actions title="Release actions" class=page-item-link>Release actions</a></ul><li class=page-item><a href=/usage/manifest/#a-stage-in-detail title="A stage in detail" class=page-item-link>A stage in detail</a><ul><li class=page-item><a href=/usage/manifest/#image title=Image class=page-item-link>Image</a><li class=page-item><a href=/usage/manifest/#shell title=Shell class=page-item-link>Shell</a><li class=page-item><a href=/usage/manifest/#working-directory title="Working directory" class=page-item-link>Working directory</a><li class=page-item><a href=/usage/manifest/#commands title=Commands class=page-item-link>Commands</a><li class=page-item><a href=/usage/manifest/#environment-variables title="Environment variables" class=page-item-link>Environment variables</a><li class=page-item><a href=/usage/manifest/#when-clause title="When clause" class=page-item-link>When clause</a><li class=page-item><a href=/usage/manifest/#retries title=Retries class=page-item-link>Retries</a><li class=page-item><a href=/usage/manifest/#custom-properties title="Custom properties" class=page-item-link>Custom properties</a></ul><li class=page-item><a href=/usage/manifest/#environment-variables title="Environment variables" class=page-item-link>Environment variables</a><li class=page-item><a href=/usage/manifest/#secret-values title="Secret values" class=page-item-link>Secret values</a><li class=page-item><a href=/usage/manifest/#triggers title=Triggers class=page-item-link>Triggers</a><ul><li class=page-item><a href=/usage/manifest/#on-pipeline-event title="On pipeline event" class=page-item-link>On pipeline event</a><li class=page-item><a href=/usage/manifest/#on-release-event title="On release event" class=page-item-link>On release event</a><li class=page-item><a href=/usage/manifest/#on-cron-schedule title="On cron schedule" class=page-item-link>On cron schedule</a><li class=page-item><a href=/usage/manifest/#on-pub-sub-event title="On pub/sub event" class=page-item-link>On pub/sub event</a></ul><li class=page-item><a href=/usage/manifest/#versioning title=Versioning class=page-item-link>Versioning</a><li class=page-item><a href=/usage/manifest/#builder-parameters title="Builder parameters" class=page-item-link>Builder parameters</a><li class=page-item><a href=/usage/manifest/#global-estafette-environment-variables title="Global Estafette environment variables" class=page-item-link>Global Estafette environment variables</a><li class=page-item><a href=/usage/manifest/#other title=Other class=page-item-link>Other</a></ul></li></ul></div></div></div></div></div><nav class="footer nav justify-content-end bg-dark p-2"><a href=https://github.com/estafette/estafette-ci-central target=_blank class="nav-link text-light">Github</a></nav><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script></body></html>