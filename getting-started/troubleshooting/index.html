<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-464018-9"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-464018-9');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=xQdjvJ8Lmw"><link rel=manifest href="/site.webmanifest?v=xQdjvJ8Lmw"><link rel=mask-icon href="/safari-pinned-tab.svg?v=xQdjvJ8Lmw" color=#28a745><link rel="shortcut icon" href="/favicon.ico?v=xQdjvJ8Lmw"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><title>Troubleshooting &ndash; Estafette CI/CD</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://estafette.io/sass/estafette.min.7f9f3ad31f44302446582e482cb18d648864a1d57e5e96611384029e40696adb.css integrity="sha256-f5860x9EMCRGWC5ILLGNZIhkodV+XpZhE4QCnkBpats="></head><body><div id=header-and-main><nav class="navbar navbar-dark bg-dark navbar-expand-md"><a href=/ class="navbar-brand text-white mr-3 router-link-exact-active active" target=_self><svg style="width:1.25em;overflow:visible;vertical-align:-2.5px" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="shipping-fast" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="m-0 ml-2 mr-2 h5 svg-inline--fa fa-shipping-fast fa-w-20"><path fill="currentcolor" d="M624 352h-16V243.9c0-12.7-5.1-24.9-14.1-33.9L494 110.1c-9-9-21.2-14.1-33.9-14.1H416V48c0-26.5-21.5-48-48-48H112C85.5.0 64 21.5 64 48v48H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h272c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H40c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H64v128c0 53 43 96 96 96s96-43 96-96h128c0 53 43 96 96 96s96-43 96-96h48c8.8.0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zM160 464c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm320 0c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm80-208H416V144h44.1l99.9 99.9V256z"/></svg><em class=align-top>Estafette</em></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNavAltMarkup aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavAltMarkup><div class=navbar-nav><a class="nav-item nav-link active" href=/getting-started/>Getting started</a><a class="nav-item nav-link" href=/usage/>Usage</a><a class="nav-item nav-link" href=/design/>Design</a><a class="nav-item nav-link" href=/development/>Development</a></div></div></nav><div id=main><div class=container-fluid><div class="row mt-4 mb-4"><div class="col d-none d-md-flex border-right sidebar sticky-top"><ul><li class=section-item><a href=/getting-started/ class="section-item-link ancestor">Getting started</a><ul><li class=page-item><a href=/getting-started/installation/ class=page-item-link>Installation</a></li><li class=section-item><a href=/getting-started/tls-certmanager/ class=section-item-link>TLS with certmanager</a></li><li class=section-item><a href=/getting-started/tls-estafette-letsencrypt/ class=section-item-link>TLS with estafette controller</a></li><li class=section-item><a href=/getting-started/github-login/ class=section-item-link>Github login</a></li><li class=section-item><a href=/getting-started/google-login/ class=section-item-link>Google login</a></li><li class=section-item><a href=/getting-started/bitbucket-integration/ class=section-item-link>Bitbucket integration</a></li><li class=section-item><a href=/getting-started/github-integration/ class=section-item-link>Github integration</a></li><li class=section-item><a href=/getting-started/identity-aware-proxy/ class=section-item-link>Identity Aware Proxy (IAP)</a></li><li class=section-item><a href=/getting-started/production-high-availability/ class=section-item-link>Production / High Availability</a></li><li class=section-item><a href=/getting-started/security-considerations/ class=section-item-link>Security considerations</a></li><li class=section-item><a href=/getting-started/troubleshooting/ class="section-item-link ancestor active">Troubleshooting</a></li><li class=section-item><a href=/getting-started/disaster-recovery/ class=section-item-link>Disaster recovery</a></li><li class=page-item><a href=/getting-started/configuration/ class=page-item-link>Configuration reference</a></li></ul></li><li class=section-item><a href=/usage/ class=section-item-link>Usage</a></li><li class=section-item><a href=/design/ class=section-item-link>Design</a></li><li class=section-item><a href=/development/ class=section-item-link>Development</a></li></ul></div><div class="col pl-5 pt-4 content-block"><div class=row><article class="col section-intro"><header><h1 class=mb-4>Troubleshooting</h1></header><h2 id=pipelines-not-triggered>Pipelines not triggered</h2><p>First check the status of the various source code management (SCM) systems to see if they have an issue deliverying webhooks:</p><ul><li><a href=https://www.githubstatus.com/>https://www.githubstatus.com/</a></li><li><a href=https://bitbucket.status.atlassian.com/>https://bitbucket.status.atlassian.com/</a></li></ul><p>If this is the case they'll eventually start delivering those webhooks and pipelines will trigger at that time.</p><p>Next thing to check is delivery of webhooks within the respective SCM:</p><ul><li>Github - <a href=https://github.com/organizations/%3Corganization%3E/settings/apps/%3Cestafette>https://github.com/organizations/&lt;organization>/settings/apps/&lt;estafette</a> app name>/advanced</li><li>Bitbucket - <a href=https://bitbucket.org/%3Cworkspace%3E/workspace/settings/applications,>https://bitbucket.org/&lt;workspace>/workspace/settings/applications,</a> select the estafette app, check delivery</li></ul><p>If you can see webhooks getting sent to Estafette but failing there it points you to where things might go wrong. Can be the ingress controller, SCM integration details in Estafette itself or something else. Check the logs for the <code>estafette-ci-api</code> component to see if there's any errors.</p><p>When nothing can be found it might have been a transient error that isn't automatically retried. You can then try to push a new empty commit just to trigger the pipeline and see if it helps:</p><pre><code>git commit --allow-empty -m &quot;trigger build&quot; &amp;&amp; git push
</code></pre><h2 id=cockroachdb-underprovisioning>CockroachDB underprovisioning</h2><p>At some point you might run into the database being underprovisioned. Make sure to set resources on all components and follow other <a href=/getting-started/production-high-availability/>Production / high availability</a> steps.</p><p>However whenever the database's pods start crashlooping it might have trouble recovering and you're often best to shrink the <em>statefulset</em> to 0 instances and then back to the original amount with</p><pre><code>kubectl scale statefulset estafette-ci-db -n estafette-ci --replicas=0
# wait for all pods to terminate
kubectl scale statefulset estafette-ci-db -n estafette-ci --replicas=3 # or whatever size you had set it to before
</code></pre><p>Now the cluster usually restarts and manages to perform the necessary leader election.</p><p>If it still keeps failing it's often that it has too little cpu. Below is an example of how to specify the resources via the Helm values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>db:
  statefulset:
    resources:
      requests:
        cpu: 2000m
        memory: 12Gi
      limits:
        memory: 42Gi
</code></pre></div><p>Best to keep memory request and limit the same for <em>guaranteed quality of service (QoS)</em>.</p><p>For more <em>CockroachDB</em> related troubleshooting tips check <a href=https://www.cockroachlabs.com/docs/stable/troubleshooting-overview.html>https://www.cockroachlabs.com/docs/stable/troubleshooting-overview.html</a>.</p><h2 id=docker-daemon-failing-to-start-or-struggling-to-execute-stages>Docker daemon failing to start or struggling to execute stages</h2><p>The <code>estafette-ci-builder</code> component running the build/release stages inside a Kubernetes job utilizing <em>Docker inside Docker</em> can put quite a lot of strain on the underlying Kubernetes nodes. On Google Cloud the default 100GB pd-standard boot disks seem to fall short a bit for Estafette CI to run really well. Upgrading those to 200GB pd-ssd boot disks should resolve any issues in this department.</p><h2 id=connectivity-failure-to-external-systems>Connectivity failure to external systems</h2><p>When running on Google Cloud or within a <em>software defined network (SDN)</em> with a smaller than default <em>MTU</em> of 1500 you can run into trouble connecting to external systems from your build/release stages, due to the way stages are executed using <em>Docker inside Docker</em>. <em>Estafette CI</em> defaults the MTU to 1460 so it works for Google Cloud, but you might have an SDN that uses an even smaller MTU. In that case you have to update the <code>config.yaml</code> with the following Helm values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  config:
    files:
      config.yaml: <span style=color:#5a2>|
</span><span style=color:#5a2>       </span><span style=color:#5a2> </span><span style=color:#5a2>apiServer:</span>
          baseURL: https://{{ $.Values.baseHost }}
          integrationsURL: https://{{ $.Values.integrationsHost }}
          serviceURL: http://{{ include <span style=color:#5a2>&#34;estafette-ci-api.fullname&#34;</span> . }}.{{ .Release.Namespace }}.svc.cluster.local
          dockerConfigPerOperatingSystem:
            linux:
              runType: dind
              mtu: &lt;MTU size of your SDN<span style=color:#5a2>&gt;
</span><span style=color:#5a2>
</span><span style=color:#5a2>       </span><span style=color:#5a2> </span><span style=color:#5a2>jobs:</span>
          namespace: {{ .Release.Namespace }}-jobs

        auth:
          jwt:
            domain: {{ $.Values.baseHost }}
</code></pre></div><p>Most of this <code>config.yaml</code>'s content is the default values used in the Helm chart and needs to be repeated here in order to make sure your Estafette CI installation is configured correctly. See <a href=https://github.com/estafette/estafette-ci/blob/main/helm/estafette-ci/charts/estafette-ci-api/values.yaml#L270-L281>https://github.com/estafette/estafette-ci/blob/main/helm/estafette-ci/charts/estafette-ci-api/values.yaml#L270-L281</a> for the defaults.</p><h2 id=configuration-errors>Configuration errors</h2><p>When your configuration file is invalid the <code>estafette-ci-api</code> component will fail and restart constantly, leading to a failure to upgrade the Helm release. Check the logs of the <code>estafette-ci-api</code> pods (with <code>kubectl logs</code> since <code>stern</code> will be too slow to catch those errors) to see which configuration item is incorrect and fix it accordingly.</p><h2 id=config-too-large-for-configmap>Config too large for configmap</h2><p>When you continue to add <em>credentials</em> to your config eventually you'll hit the maximum size of configmaps. What you can do then is store the config in a git repository and use a git-sync sidecar to fetch the config, instead of using a configmap for this.</p><p>The values you need for this is pretty big but will resolve this issue for you:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  config:
    enabled: <span style=color:#00f>false</span>
  deployment:
    extraEnv:
      - name: CONFIG_FILES_PATH
        value: /configs/git
    extraContainers: <span style=color:#5a2>|
</span><span style=color:#5a2>     </span><span style=color:#5a2> </span><span style=color:#5a2>- name: estafette-ci-api-git-sync</span>
        image: k8s.gcr.io/git-sync:v3<span style=color:#3af>.1</span><span style=color:#3af>.5</span>
        env:
        - name: GIT_SYNC_REPO
          value: <span style=color:#5a2>&#34;&lt;git repository url (ssh not https)&gt;&#34;</span>
        - name: GIT_SYNC_BRANCH
          value: <span style=color:#5a2>&#34;&lt;branch that has your config.yaml&gt;&#34;</span>
        - name: GIT_SYNC_DEPTH
          value: <span style=color:#5a2>&#34;1&#34;</span>
        - name: GIT_SYNC_ROOT
          value: <span style=color:#5a2>&#34;/configs&#34;</span>
        - name: GIT_SYNC_DEST
          value: <span style=color:#5a2>&#34;git&#34;</span>
        - name: GIT_SYNC_SSH
          value: <span style=color:#5a2>&#34;true&#34;</span>
        - name: GIT_SSH_KEY_FILE
          value: <span style=color:#5a2>&#34;/ssh/git-sync-rsa&#34;</span>
        - name: GIT_KNOWN_HOSTS
          value: <span style=color:#5a2>&#34;false&#34;</span>
        - name: GIT_SYNC_MAX_SYNC_FAILURES
          value: <span style=color:#5a2>&#34;10&#34;</span>
        - name: GIT_SYNC_WAIT
          value: <span style=color:#5a2>&#34;60&#34;</span>
        securityContext:
          runAsUser: <span style=color:#3af>65534</span> <span style=color:#888;font-style:italic># git-sync user</span>
        resources:
          requests:
            cpu: 10m
            memory: 100Mi
          limits:
            memory: 100Mi
        volumeMounts:
        - name: configs
          mountPath: /configs
        - name: secrets-ssh
          mountPath: /ssh
    extraVolumes: <span style=color:#5a2>|
</span><span style=color:#5a2>     </span><span style=color:#5a2> </span><span style=color:#5a2>- name: client-certificate</span>
        projected:
          sources:
          - secret:
              name: estafette-ci-db-client-secret
              items:
              - key: ca.crt
                path: ca.crt
                mode: <span style=color:#3af>256</span>
              - key: tls.crt
                path: tls.crt
                mode: <span style=color:#3af>256</span>
              - key: tls.key
                path: tls.key
                mode: <span style=color:#3af>256</span>
      - name: configs
        emptyDir: {}
    extraVolumeMounts: <span style=color:#5a2>|
</span><span style=color:#5a2>     </span><span style=color:#5a2> </span><span style=color:#5a2>- name: client-certificate</span>
        mountPath: /cockroach-certs
      - name: configs
        mountPath: /configs
  extraSecrets:
    - key: ssh
      mountPath: /ssh
      b64encoded: <span style=color:#00f>true</span>
      data:
        git-sync-rsa: <span style=color:#5a2>&#39;&lt;base64 encoded ssh key with read access to the git repository with config.yaml file&gt;&#39;</span>
</code></pre></div><p>Do not that the <code>extraVolumes</code> and <code>extraVolumeMounts</code> for <code>client-certificate</code> aren't needed for this trick, but are default values already used in the Helm chart, but won't be included if you do not specify them again.</p><p>Note: drawback of having this &lsquo;runtime&rsquo; configuration update method is that validation errors won't be detected during a rollout, but can happen when you update the configuration file(s) in the synced git repository. Again in this case check the logs of the <code>estafette-ci-api</code> pods (with <code>kubectl logs</code> since <code>stern</code> will be too slow to catch those errors) to see which configuration item is incorrect and fix it accordingly.</p></article></div><div class=row style=max-width:1024px></div></div><div class="col d-none d-xl-flex border-left toc sticky-top"><ul><li class=section-item><a class="section-item-link ancestor">Table of contents</a><ul><li class=page-item><a href=/getting-started/troubleshooting/#pipelines-not-triggered title="Pipelines not triggered" class=page-item-link>Pipelines not triggered</a><li class=page-item><a href=/getting-started/troubleshooting/#cockroachdb-underprovisioning title="CockroachDB underprovisioning" class=page-item-link>CockroachDB underprovisioning</a><li class=page-item><a href=/getting-started/troubleshooting/#docker-daemon-failing-to-start-or-struggling-to-execute-stages title="Docker daemon failing to start or struggling to execute stages" class=page-item-link>Docker daemon failing to start or struggling to execute stages</a><li class=page-item><a href=/getting-started/troubleshooting/#connectivity-failure-to-external-systems title="Connectivity failure to external systems" class=page-item-link>Connectivity failure to external systems</a><li class=page-item><a href=/getting-started/troubleshooting/#configuration-errors title="Configuration errors" class=page-item-link>Configuration errors</a><li class=page-item><a href=/getting-started/troubleshooting/#config-too-large-for-configmap title="Config too large for configmap" class=page-item-link>Config too large for configmap</a></ul></li></ul></div></div></div></div></div><nav class="footer nav justify-content-end bg-dark p-2"><a href=https://github.com/estafette/estafette-ci-central target=_blank class="nav-link text-light">Github</a></nav><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script></body></html>