<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-464018-9"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-464018-9');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=xQdjvJ8Lmw"><link rel=manifest href="/site.webmanifest?v=xQdjvJ8Lmw"><link rel=mask-icon href="/safari-pinned-tab.svg?v=xQdjvJ8Lmw" color=#28a745><link rel="shortcut icon" href="/favicon.ico?v=xQdjvJ8Lmw"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><title>Production / High Availability &ndash; Estafette CI/CD</title><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://estafette.io/sass/estafette.min.7f9f3ad31f44302446582e482cb18d648864a1d57e5e96611384029e40696adb.css integrity="sha256-f5860x9EMCRGWC5ILLGNZIhkodV+XpZhE4QCnkBpats="></head><body><div id=header-and-main><nav class="navbar navbar-dark bg-dark navbar-expand-md"><a href=/ class="navbar-brand text-white mr-3 router-link-exact-active active" target=_self><svg style="width:1.25em;overflow:visible;vertical-align:-2.5px" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="shipping-fast" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="m-0 ml-2 mr-2 h5 svg-inline--fa fa-shipping-fast fa-w-20"><path fill="currentcolor" d="M624 352h-16V243.9c0-12.7-5.1-24.9-14.1-33.9L494 110.1c-9-9-21.2-14.1-33.9-14.1H416V48c0-26.5-21.5-48-48-48H112C85.5.0 64 21.5 64 48v48H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h272c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H40c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H64v128c0 53 43 96 96 96s96-43 96-96h128c0 53 43 96 96 96s96-43 96-96h48c8.8.0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zM160 464c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm320 0c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm80-208H416V144h44.1l99.9 99.9V256z"/></svg><em class=align-top>Estafette</em></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNavAltMarkup aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavAltMarkup><div class=navbar-nav><a class="nav-item nav-link active" href=/getting-started/>Getting started</a><a class="nav-item nav-link" href=/usage/>Usage</a><a class="nav-item nav-link" href=/security/>Security</a><a class="nav-item nav-link" href=/design/>Design</a><a class="nav-item nav-link" href=/screenshots/>Screenshots</a></div></div></nav><div id=main><div class=container-fluid><div class="row mt-4 mb-4"><div class="col d-none d-md-flex border-right sidebar sticky-top"><ul><li class=section-item><a href=/getting-started/ class="section-item-link ancestor">Getting started</a><ul><li class=page-item><a href=/getting-started/installation/ class=page-item-link>Installation</a></li><li class=section-item><a href=/getting-started/tls-certmanager/ class=section-item-link>TLS with certmanager</a></li><li class=section-item><a href=/getting-started/tls-estafette-letsencrypt/ class=section-item-link>TLS with estafette controller</a></li><li class=section-item><a href=/getting-started/github-login/ class=section-item-link>Github login</a></li><li class=section-item><a href=/getting-started/google-login/ class=section-item-link>Google login</a></li><li class=section-item><a href=/getting-started/bitbucket-integration/ class=section-item-link>Bitbucket integration</a></li><li class=section-item><a href=/getting-started/github-integration/ class=section-item-link>Github integration</a></li><li class=section-item><a href=/getting-started/identity-aware-proxy/ class=section-item-link>Identity Aware Proxy (IAP)</a></li><li class=section-item><a href=/getting-started/production-high-availability/ class="section-item-link ancestor active">Production / High Availability</a></li><li class=section-item><a href=/getting-started/disaster-recovery/ class=section-item-link>Disaster recovery</a></li><li class=page-item><a href=/getting-started/configuration/ class=page-item-link>Other configuration</a></li></ul></li><li class=section-item><a href=/usage/ class=section-item-link>Usage</a></li><li class=section-item><a href=/security/ class=section-item-link>Security</a></li><li class=section-item><a href=/design/ class=section-item-link>Design</a></li><li class=section-item><a href=/screenshots/ class=section-item-link>Screenshots</a></li></ul></div><div class="col pl-5 pt-4 content-block"><div class=row><article class="col section-intro"><header><h1 class=mb-4>Production / High Availability</h1></header><p>By default this Helm chart sets up <em>Estafette CI</em> so that you can have a look at it, try it out, without requiring too much resources. However in order to run it in production you do want to tune some settings in order for all components to run in High Availability (HA) mode.</p><h2 id=default-values>Default values</h2><p>Having a look at the default values reveals how many replicas of each component is installed. It is notable that <em>Cockroachdb</em> is the only component already running in HA mode. This is because it's much harder to change it into HA once it's initialized. For other components it's no problem to do the change at a later stage.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  deployment:
    replicaCount: <span style=color:#3af>1</span>
  autoscaling:
    enabled: <span style=color:#00f>false</span>
web:
  deployment:
    replicaCount: <span style=color:#3af>1</span>
  autoscaling:
    enabled: <span style=color:#00f>false</span>
db:
  statefulset:
    replicas: <span style=color:#3af>3</span>
metrics:
  server:
    replicaCount: <span style=color:#3af>1</span>
queue:
  cluster:
    enabled: <span style=color:#00f>false</span>
</code></pre></div><h2 id=high-availability>High Availability</h2><p>In order to have all the components that are there to handle browser requests, web hooks, storage or internal communication run in <em>High Availability</em> mode use the following values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  deployment:
    replicaCount: <span style=color:#3af>3</span>
  autoscaling:
    enabled: <span style=color:#00f>true</span>
web:
  deployment:
    replicaCount: <span style=color:#3af>3</span>
  autoscaling:
    enabled: <span style=color:#00f>true</span>
db:
  statefulset:
    replicas: <span style=color:#3af>3</span>
metrics:
  server:
    replicaCount: <span style=color:#3af>2</span>
queue:
  cluster:
    enabled: <span style=color:#00f>true</span>
    replicas: <span style=color:#3af>3</span>
</code></pre></div><h2 id=resources>Resources</h2><p>It also make sense to set resource requests and limits for each component so it gets the cpu and memory it needs:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  deployment:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 256Mi
web:
  deployment:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 128Mi
db:
  statefulset:
    resources:
      requests:
        cpu: 2000m
        memory: 12Gi
      limits:
        memory: 12Gi
metrics:
  server:
    resources:
      requests:
        cpu: 1000m
        memory: 6Gi
      limits:
        memory: 6Gi
queue:
  nats:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 128Mi
</code></pre></div><p>Do not these are just example values and you should tune resources over time and monitor them closely to see when you're either overprovisioning or underprovisiong each of the components.</p><h2 id=avoid-docker-hub-rate-limits>Avoid Docker Hub rate limits</h2><p>Since Docker Hub introduced lowered rate limits for anonymous pulls - see <a href=https://www.docker.com/increase-rate-limits>https://www.docker.com/increase-rate-limits</a> - it's good practice to use <em>image pull secrets</em> for all of the containers pulled from Docker Hub. You can do so by creating a Docker Hub account and generate a token. Once you have those apply the following values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
web:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
db:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
cron-event-sender:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
hanging-job-cleaner:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
db-migrator:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
db-client:
  image:
    credentials:
      registry: docker.io
      username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
      password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
metrics:
  imagePullSecrets:
  - name: estafette-ci-api.registry
queue:
  imagePullSecrets:
  - name: estafette-ci-api.registry
</code></pre></div><p>In order to ensure builds also use credentials in order to elevate <em>docker pull</em> quota add a credentials of type <code>container-registry-pull</code> in the following way:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  config:
    files:
      credentials.yaml: <span style=color:#5a2>|
</span><span style=color:#5a2>       </span><span style=color:#5a2> </span><span style=color:#5a2>credentials:</span>
        - name: <span style=color:#5a2>&#39;docker-hub-pull&#39;</span>
          type: <span style=color:#5a2>&#39;container-registry-pull&#39;</span>
          username: <span style=color:#5a2>&#39;&lt;docker hub user&gt;&#39;</span>
          password: <span style=color:#5a2>&#39;&lt;docker hub token&gt;&#39;</span>
</code></pre></div><p>These will be used both as an <em>image pull secret</em> for the build/release jobs itself and for pulling stage container images inside of each build/release.</p><h2 id=store-logs-in-cloud-storage>Store logs in Cloud Storage</h2><p>By default full build and release logs are stored in the database. With large numbers of builds this can put a lot of stress on the database and it's also more costly than storing logs in Cloud Storage instead.</p><p>First go through the following steps</p><ol><li>Create a cloud storage bucket</li><li>Create a service account</li><li>Give the service account read/write permissions on the storage bucket</li><li>Get a keyfile for the service account</li></ol><p>Then update the values by adding the following:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>api:
  deployment:
    extraEnv:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        value: /iam/service-account-key.json
      - name: ESCI_APISERVER_LOGWRITERS
        value: cloudstorage
      - name: ESCI_APISERVER_LOGREADER
        value: cloudstorage
      - name: ESCI_INTEGRATIONS_GCS_ENABLE
        value: <span style=color:#5a2>&#39;true&#39;</span>
      - name: ESCI_INTEGRATIONS_GCS_BUCKET
        value: <span style=color:#5a2>&#39;&lt;bucket name&gt;&#39;</span>
  extraSecrets:
    - key: iam
      mountPath: /iam
      b64encoded: <span style=color:#00f>true</span>
      data:
        service-account-key.json: <span style=color:#5a2>&#39;{base64 encoded key file}&#39;</span>
</code></pre></div><p>This will ensure the <em>api</em> component has a service account keyfile that allows it to read and write logs from and to a cloud storage bucket.</p><p>Note: logs already stored in the database won't be moved over and won't be shown either when navigating to the respective log pages, so best to configured before you run any pipelines in a new installation.</p><h2 id=store-your-helm-values>Store your helm values</h2><p>For <em>disaster recovery</em> it makes sense to keep your values file stored somewhere and have the unencrypted secrets used in those safed somewhere secure as well. You want this in order to be able to manually install the Helm release at any time, if any of the pipelines you usually use to upgrade Estafette CI are broken themselves.</p><p>See the <a href=/getting-started/disaster-recovery/>Disaster recovery</a> section for more detail on how to restore functionality.</p><h2 id=cockroachdb-backup>CockroachDB backup</h2><p>The most critical part of <em>Estafette CI</em> to safeguard for disaster discovery is the data stored in the database. The default database used by Estafette is CockroachDB. You'll have to set up a <em>backup schedule</em> as documented at <a href=https://www.cockroachlabs.com/docs/stable/manage-a-backup-schedule.html>https://www.cockroachlabs.com/docs/stable/manage-a-backup-schedule.html</a> in order to have daily backups of the database.</p><p>In order to connect to the Cockroachdb database to perform queries, the Helm chart has a <code>db-client</code> subchart, that's disabled by default. You can enabled it by setting values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>db-client:
  enabled: <span style=color:#00f>true</span>
</code></pre></div><p>This will spin up a pod named <code>estafette-ci-db-client</code> which you can &lsquo;log in to&rsquo; with the following command:</p><pre><code>kubectl exec -it estafette-ci-db-client -n estafette-ci \
-- ./cockroach sql \
--certs-dir=/cockroach-certs \
--host=estafette-ci-db-public
</code></pre><p>From here on you can follow the instructions as listed by the documentation of Cockroachdb.</p><p>For example in order to create a scheduled backup to Google Cloud Storage</p><ol><li>Create a cloud storage bucket</li><li>Create a service account</li><li>Give the service account read/write permissions on the storage bucket</li><li>Get a keyfile for the service account</li><li>Execute the following query in the <code>estafette-ci-db-client</code>:</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00f>CREATE</span> <span style=color:#000>SCHEDULE</span> <span style=color:#000>schedule_label</span>
  <span style=color:#00f>FOR</span> <span style=color:#000>BACKUP</span> <span style=color:#00f>INTO</span> <span style=color:#5a2>&#39;</span><span style=color:#5a2>gs://{bucket name}/backups/daily?AUTH=specified&amp;CREDENTIALS={base64 encoded key}</span><span style=color:#5a2>&#39;</span>
    <span style=color:#00f>WITH</span> <span style=color:#000>revision_history</span>
    <span style=color:#000>RECURRING</span> <span style=color:#5a2>&#39;</span><span style=color:#5a2>@daily</span><span style=color:#5a2>&#39;</span>
    <span style=color:#00f>WITH</span> <span style=color:#000>SCHEDULE</span> <span style=color:#00f>OPTIONS</span> <span style=color:#000>first_run</span> = <span style=color:#5a2>&#39;</span><span style=color:#5a2>now</span><span style=color:#5a2>&#39;</span>;
</code></pre></div><p>Once you're done best to disable the <em>db-client</em> again by updating the values to</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>db-client:
  enabled: <span style=color:#00f>false</span>
</code></pre></div><h2 id=back-up-decryption-key>Back up decryption key</h2><p>In case you're already using <em>Estafette secrets</em> in build manifests and centrally configured <em>credentials</em> you'll need a backup of the encryption/decryption key. You can get it's value with</p><pre><code>kubectl get secret --namespace estafette-ci estafette-ci-api -o jsonpath=&quot;{.data.secretDecryptionKey}&quot; | base64 --decode ; echo
</code></pre><p>Best store this securely in a password manager. This is the most sensitive piece of data used by Estafette. Once it leaks everyone can decrypt any of the <em>Estafette secrets</em> used by the system.</p></article></div><div class=row style=max-width:1024px></div></div><div class="col d-none d-xl-flex border-left toc sticky-top"><ul><li class=section-item><a class="section-item-link ancestor">Table of contents</a><ul><li class=page-item><a href=/getting-started/production-high-availability/#default-values title="Default values" class=page-item-link>Default values</a><li class=page-item><a href=/getting-started/production-high-availability/#high-availability title="High Availability" class=page-item-link>High Availability</a><li class=page-item><a href=/getting-started/production-high-availability/#resources title=Resources class=page-item-link>Resources</a><li class=page-item><a href=/getting-started/production-high-availability/#avoid-docker-hub-rate-limits title="Avoid Docker Hub rate limits" class=page-item-link>Avoid Docker Hub rate limits</a><li class=page-item><a href=/getting-started/production-high-availability/#store-logs-in-cloud-storage title="Store logs in Cloud Storage" class=page-item-link>Store logs in Cloud Storage</a><li class=page-item><a href=/getting-started/production-high-availability/#store-your-helm-values title="Store your helm values" class=page-item-link>Store your helm values</a><li class=page-item><a href=/getting-started/production-high-availability/#cockroachdb-backup title="CockroachDB backup" class=page-item-link>CockroachDB backup</a><li class=page-item><a href=/getting-started/production-high-availability/#back-up-decryption-key title="Back up decryption key" class=page-item-link>Back up decryption key</a></ul></li></ul></div></div></div></div></div><nav class="footer nav justify-content-end bg-dark p-2"><a href=https://github.com/estafette/estafette-ci-central target=_blank class="nav-link text-light">Github</a></nav><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script></body></html>