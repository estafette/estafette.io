<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-464018-9"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-464018-9');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=xQdjvJ8Lmw"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=xQdjvJ8Lmw"><link rel=manifest href="/site.webmanifest?v=xQdjvJ8Lmw"><link rel=mask-icon href="/safari-pinned-tab.svg?v=xQdjvJ8Lmw" color=#28a745><link rel="shortcut icon" href="/favicon.ico?v=xQdjvJ8Lmw"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><title>Disaster recovery &ndash; Estafette CI/CD</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://estafette.io/sass/estafette.min.7f9f3ad31f44302446582e482cb18d648864a1d57e5e96611384029e40696adb.css integrity="sha256-f5860x9EMCRGWC5ILLGNZIhkodV+XpZhE4QCnkBpats="></head><body><div id=header-and-main><nav class="navbar navbar-dark bg-dark navbar-expand-md"><a href=/ class="navbar-brand text-white mr-3 router-link-exact-active active" target=_self><svg style="width:1.25em;overflow:visible;vertical-align:-2.5px" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="shipping-fast" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="m-0 ml-2 mr-2 h5 svg-inline--fa fa-shipping-fast fa-w-20"><path fill="currentcolor" d="M624 352h-16V243.9c0-12.7-5.1-24.9-14.1-33.9L494 110.1c-9-9-21.2-14.1-33.9-14.1H416V48c0-26.5-21.5-48-48-48H112C85.5.0 64 21.5 64 48v48H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h272c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H40c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H8c-4.4.0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h208c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H64v128c0 53 43 96 96 96s96-43 96-96h128c0 53 43 96 96 96s96-43 96-96h48c8.8.0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zM160 464c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm320 0c-26.5.0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm80-208H416V144h44.1l99.9 99.9V256z"/></svg><em class=align-top>Estafette</em></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNavAltMarkup aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavAltMarkup><div class=navbar-nav><a class="nav-item nav-link active" href=/getting-started/>Getting started</a><a class="nav-item nav-link" href=/usage/>Usage</a><a class="nav-item nav-link" href=/design/>Design</a><a class="nav-item nav-link" href=/development/>Development</a></div></div></nav><div id=main><div class=container-fluid><div class="row mt-4 mb-4"><div class="col d-none d-md-flex border-right sidebar sticky-top"><ul><li class=section-item><a href=/getting-started/ class="section-item-link ancestor">Getting started</a><ul><li class=page-item><a href=/getting-started/installation/ class=page-item-link>Installation</a></li><li class=section-item><a href=/getting-started/tls-certmanager/ class=section-item-link>TLS with certmanager</a></li><li class=section-item><a href=/getting-started/tls-estafette-letsencrypt/ class=section-item-link>TLS with estafette controller</a></li><li class=section-item><a href=/getting-started/github-login/ class=section-item-link>Github login</a></li><li class=section-item><a href=/getting-started/google-login/ class=section-item-link>Google login</a></li><li class=section-item><a href=/getting-started/bitbucket-integration/ class=section-item-link>Bitbucket integration</a></li><li class=section-item><a href=/getting-started/github-integration/ class=section-item-link>Github integration</a></li><li class=section-item><a href=/getting-started/identity-aware-proxy/ class=section-item-link>Identity Aware Proxy (IAP)</a></li><li class=section-item><a href=/getting-started/production-high-availability/ class=section-item-link>Production / High Availability</a></li><li class=section-item><a href=/getting-started/security-considerations/ class=section-item-link>Security considerations</a></li><li class=section-item><a href=/getting-started/troubleshooting/ class=section-item-link>Troubleshooting</a></li><li class=section-item><a href=/getting-started/disaster-recovery/ class="section-item-link ancestor active">Disaster recovery</a></li><li class=page-item><a href=/getting-started/configuration/ class=page-item-link>Configuration reference</a></li></ul></li><li class=section-item><a href=/usage/ class=section-item-link>Usage</a></li><li class=section-item><a href=/design/ class=section-item-link>Design</a></li><li class=section-item><a href=/development/ class=section-item-link>Development</a></li></ul></div><div class="col pl-5 pt-4 content-block"><div class=row><article class="col section-intro"><header><h1 class=mb-4>Disaster recovery</h1></header><p>Estafette CI is a pretty resilient system, but of course an incident can happen. Like wiping out a complete namespace by accident. This will not only loose you all of the pipeline build version numbers and references to the logs, but also the master encryption/decryption key.</p><h2 id=recreaterepair-helm-release>Recreate/repair Helm release</h2><p>If your Estafette CI release somehow managed to become corrupt or deleted you can reinstall it with the instructions below. Do ensure you have the original <code>values.yaml</code> file stored somewhere. And also have any of the secrets used during installation at hand.</p><pre><code>helm repo add estafette https://helm.estafette.io
helm repo update

# check diff
helm diff upgrade estafette-ci estafette/estafette-ci -n estafette-ci --values local-values.yaml --set api.secret.secretDecryptionKey=&lt;base64 encoded secret decryption key&gt;

# apply changes
helm upgrade --install estafette-ci estafette/estafette-ci -n estafette-ci --create-namespace --values local-values.yaml --timeout 600s --set api.secret.secretDecryptionKey=&lt;base64 encoded secret decryption key&gt; --set db-migrator.enable=false
</code></pre><p>Any of the secret values you might use can be passed with the <code>--set</code> argument. Make sure you've stored these commands somewhere secure, like in a password manager, so you don't have to figure out all of the secrets when trying to restore functionality.</p><p>Note: the <code>db-migrator</code> component needs to be disabled if the database needs to be restored from a backup, otherwise it already creates database tables which makes it impossible for a backup to be restored.</p><h2 id=cockroachdb-restore-backup>CockroachDB restore backup</h2><p>If you've following the instructions in the <a href=/getting-started/production-high-availability/>Production / high availability</a> section you've already set up a daily backup for Estafette's Cockroachdb database.</p><p>After having followed the instructions above you hopefully still have all of your data, but in case you threw away all the <em>Persistent Volume Claims</em> for the database you will have to restore it from your backup.</p><p>Note: You can't restore a backup in a database that already has a schema, so this section is only useful for recovering from scratch. If your database somehow got corrupted you will have to shrink the statefulset to 0, delete the pvc's and restore it to it's original number of replicas before continuing with the following steps.</p><p>In order to connect to the Cockroachdb database to perform queries, the Helm chart has a <code>db-client</code> subchart, that's disabled by default. You can enabled it by setting values:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>db-client:
  enabled: <span style=color:#00f>true</span>
db-migrator:
  enabled: <span style=color:#00f>false</span>
</code></pre></div><p>This will spin up a pod named <code>estafette-ci-db-client</code> which you can &lsquo;log in to&rsquo; with the following command:</p><pre><code>kubectl exec -it estafette-ci-db-client -n estafette-ci \
-- ./cockroach sql \
--certs-dir=/cockroach-certs \
--host=estafette-ci-db-public
</code></pre><p>From here on you can follow the instructions as listed by the documentation of Cockroachdb.</p><p>For example in order to create a scheduled backup to Google Cloud Storage</p><ol><li>Get a keyfile for the service account used for the scheduled backup</li><li>Execute the following query in the <code>estafette-ci-db-client</code>:</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>RESTORE</span>
  <span style=color:#00f>FROM</span> <span style=color:#5a2>&#39;</span><span style=color:#5a2>gs://{bucket name}/db-backups?AUTH=specified&amp;CREDENTIALS={base64 encoded key}</span><span style=color:#5a2>&#39;</span>;
</code></pre></div><p>Once you're done best to disable the <em>db-client</em> again by updating the values to</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>db-client:
  enabled: <span style=color:#00f>false</span>
db-migrator:
  enabled: <span style=color:#00f>true</span>
</code></pre></div><p>and making sure to either pass <code>--set db-migrator.enable=true</code> to <code>helm upgrade</code> or skip overriding this value completely. This will let the <code>db-migrator</code> perform any schema changes that still need to happen, although with a daily backup the schema should be up to date.</p><h2 id=what-doesnt-get-restored>What doesn't get restored</h2><p>When recreating your Estafette installations the Bitbucket and Github integration details will not be recovered. This means you will have to go through the instructions at <a href=/getting-started/github-integration/>Github integration</a> and/or <a href=/getting-started/bitbucket-integration/>Bitbucket integration</a> again.</p></article></div><div class=row style=max-width:1024px></div></div><div class="col d-none d-xl-flex border-left toc sticky-top"><ul><li class=section-item><a class="section-item-link ancestor">Table of contents</a><ul><li class=page-item><a href=/getting-started/disaster-recovery/#recreaterepair-helm-release title="Recreate/repair Helm release" class=page-item-link>Recreate/repair Helm release</a><li class=page-item><a href=/getting-started/disaster-recovery/#cockroachdb-restore-backup title="CockroachDB restore backup" class=page-item-link>CockroachDB restore backup</a><li class=page-item><a href=/getting-started/disaster-recovery/#what-doesnt-get-restored title="What doesn't get restored" class=page-item-link>What doesn't get restored</a></ul></li></ul></div></div></div></div></div><nav class="footer nav justify-content-end bg-dark p-2"><a href=https://github.com/estafette/estafette-ci-central target=_blank class="nav-link text-light">Github</a></nav><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script></body></html>